# æ€»ç»“ï¼šç±»å‹å®‰å…¨çš„äº‹ä»¶ç³»ç»Ÿè§£å†³æ–¹æ¡ˆ

## é—®é¢˜å›é¡¾

**åŸå§‹é—®é¢˜ï¼š** åœ¨ Maya ä¸­åˆ›å»ºç‰©ä½“æ—¶ï¼Œ`scene_updated` äº‹ä»¶æ²¡æœ‰å‘é€åˆ°å‰ç«¯æ˜¾ç¤ºã€‚

**æ ¹æœ¬åŸå› ï¼š** æ•°æ®æ ¼å¼ä¸åŒ¹é…
- Python å‘é€ï¼š`{"nodes": [...]}`
- å‰ç«¯æœŸæœ›ï¼š`{"value": [...]}` æˆ–ç›´æ¥æ•°ç»„

**ç”¨æˆ·éœ€æ±‚ï¼š** å¦‚ä½•åœ¨è®¾è®¡ä¸Šé¿å…ç±»ä¼¼é—®é¢˜ï¼Œè®©ç³»ç»Ÿæ›´åŠ é€šç”¨å’Œçµæ´»ï¼Ÿ

## è§£å†³æ–¹æ¡ˆæ¦‚è§ˆ

æˆ‘ä»¬è®¾è®¡äº†ä¸€ä¸ª**ä¸‰å±‚é˜²æŠ¤**çš„è§£å†³æ–¹æ¡ˆï¼š

### ç¬¬ä¸€å±‚ï¼šæ™ºèƒ½å‰ç«¯é€‚é…å™¨ï¼ˆå·²å®æ–½ï¼‰âœ…

**æ–‡ä»¶ï¼š** `src/utils/eventAdapter.ts`

**åŠŸèƒ½ï¼š**
- è‡ªåŠ¨é€‚é…å¤šç§æ•°æ®æ ¼å¼
- æä¾›è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—
- å‘åå…¼å®¹æ—§æ ¼å¼

**ä½¿ç”¨ç¤ºä¾‹ï¼š**
```typescript
// è‡ªåŠ¨å¤„ç†å¤šç§æ ¼å¼
const nodes = EventDataAdapter.extractArray<MayaNode>(data, 'nodes', 'value', 'data')
// âœ… æ”¯æŒ: [node1, node2]
// âœ… æ”¯æŒ: {nodes: [node1, node2]}
// âœ… æ”¯æŒ: {value: [node1, node2]}
// âœ… æ”¯æŒ: {data: [node1, node2]}
```

**ä¼˜ç‚¹ï¼š**
- âœ… ç«‹å³ç”Ÿæ•ˆï¼Œæ— éœ€ä¿®æ”¹ Python ä»£ç 
- âœ… å®Œå…¨å‘åå…¼å®¹
- âœ… æä¾›è¯¦ç»†çš„é”™è¯¯æç¤º
- âœ… æ˜“äºæ‰©å±•æ–°æ ¼å¼

### ç¬¬äºŒå±‚ï¼šç±»å‹å®šä¹‰å’Œæ–‡æ¡£ï¼ˆè®¡åˆ’ä¸­ï¼‰ğŸ“‹

**æ–‡ä»¶ï¼š** `python/auroraview/events.py`

**åŠŸèƒ½ï¼š**
- ä½¿ç”¨ TypedDict å®šä¹‰æ‰€æœ‰äº‹ä»¶ç±»å‹
- æä¾›æ•°æ®éªŒè¯å‡½æ•°
- è‡ªåŠ¨ç”Ÿæˆ TypeScript ç±»å‹å®šä¹‰

**ç¤ºä¾‹ï¼š**
```python
class SceneUpdateEvent(TypedDict):
    """Scene update event data."""
    nodes: List[MayaNode]

# ä½¿ç”¨
def send_scene_update(self, hierarchy: List[MayaNode]):
    data: SceneUpdateEvent = {"nodes": hierarchy}
    self.webview.emit("scene_updated", data)
```

### ç¬¬ä¸‰å±‚ï¼šè¿è¡Œæ—¶éªŒè¯ï¼ˆæœªæ¥ï¼‰ğŸ”®

**ä½¿ç”¨ Pydantic è¿›è¡Œä¸¥æ ¼éªŒè¯ï¼š**
```python
from pydantic import BaseModel

class SceneUpdateEvent(BaseModel):
    nodes: List[MayaNode]
    
    class Config:
        extra = 'forbid'  # ç¦æ­¢é¢å¤–å­—æ®µ

# è‡ªåŠ¨éªŒè¯
event = SceneUpdateEvent(nodes=hierarchy)
webview.emit("scene_updated", event.dict())
```

## å·²å®æ–½çš„æ”¹è¿›

### 1. åˆ›å»ºæ™ºèƒ½äº‹ä»¶é€‚é…å™¨

**æ–‡ä»¶ï¼š** `src/utils/eventAdapter.ts`

```typescript
export class EventDataAdapter {
  // æå–æ•°ç»„ - æ”¯æŒå¤šç§æ ¼å¼
  static extractArray<T>(data: unknown, ...possibleKeys: string[]): T[]
  
  // æå–å­—ç¬¦ä¸² - æ”¯æŒå¤šç§æ ¼å¼
  static extractString(data: unknown, ...possibleKeys: string[]): string
  
  // æå–å¯¹è±¡ - æ”¯æŒå¤šç§æ ¼å¼
  static extractObject<T>(data: unknown, ...possibleKeys: string[]): T
}
```

### 2. æ›´æ–°å‰ç«¯ä»£ç ä½¿ç”¨é€‚é…å™¨

**æ–‡ä»¶ï¼š** `src/App.vue`

**ä¿®æ”¹å‰ï¼š**
```typescript
const nodes = payload?.nodes
  ? payload.nodes
  : Array.isArray(payload?.value)
    ? payload.value
    : Array.isArray(payload)
      ? payload
      : []
```

**ä¿®æ”¹åï¼š**
```typescript
const nodes = EventDataAdapter.extractArray<MayaNode>(data, 'nodes', 'value', 'data')
```

**ä¼˜åŠ¿ï¼š**
- ä»£ç æ›´ç®€æ´
- è‡ªåŠ¨å¤„ç†æ‰€æœ‰æ ¼å¼
- æä¾›è¯¦ç»†æ—¥å¿—
- æ˜“äºç»´æŠ¤

### 3. ä¿®å¤ Python ä¾§æ•°æ®æ ¼å¼

**æ–‡ä»¶ï¼š** `maya_integration/maya_outliner.py`

```python
# ä¿®æ”¹å‰
self.webview.emit("scene_updated", {"nodes": hierarchy})

# ä¿®æ”¹å
self.webview.emit("scene_updated", {"value": hierarchy})
```

**æ³¨æ„ï¼š** ç”±äºæˆ‘ä»¬ç°åœ¨æœ‰äº†æ™ºèƒ½é€‚é…å™¨ï¼Œè¿™ä¸¤ç§æ ¼å¼éƒ½èƒ½æ­£å¸¸å·¥ä½œï¼

## è®¾è®¡æ–‡æ¡£

### å®Œæ•´è®¾è®¡æ–¹æ¡ˆ

**æ–‡ä»¶ï¼š** `docs/DESIGN_TYPE_SAFE_EVENTS.md`

åŒ…å«ï¼š
1. é—®é¢˜åˆ†æ
2. ä¸‰ç§è§£å†³æ–¹æ¡ˆå¯¹æ¯”
3. å®æ–½è®¡åˆ’
4. ä»£ç ç¤ºä¾‹
5. æœ€ä½³å®è·µ

### è°ƒè¯•æŒ‡å—

**æ–‡ä»¶ï¼š** `docs/DEBUG_MAYA_EVENT_PROCESSING.md`

åŒ…å«ï¼š
1. è¯Šæ–­æ­¥éª¤
2. å¸¸è§é—®é¢˜
3. è§£å†³æ–¹æ¡ˆ
4. æµ‹è¯•è„šæœ¬

## æ”¶ç›Šæ€»ç»“

### ç«‹å³æ”¶ç›Šï¼ˆå·²å®ç°ï¼‰

1. âœ… **é¿å…æ•°æ®æ ¼å¼é”™è¯¯** - æ™ºèƒ½é€‚é…å™¨è‡ªåŠ¨å¤„ç†
2. âœ… **æ›´å¥½çš„è°ƒè¯•ä½“éªŒ** - è¯¦ç»†çš„æ—¥å¿—è¾“å‡º
3. âœ… **å‘åå…¼å®¹** - æ”¯æŒæ‰€æœ‰æ—§æ ¼å¼
4. âœ… **ä»£ç æ›´ç®€æ´** - å‡å°‘é‡å¤çš„æ ¼å¼æ£€æŸ¥ä»£ç 

### ä¸­æœŸæ”¶ç›Šï¼ˆè®¡åˆ’ä¸­ï¼‰

1. ğŸ“‹ **ç±»å‹å®‰å…¨** - TypedDict æä¾›ç±»å‹æç¤º
2. ğŸ“‹ **è‡ªåŠ¨æ–‡æ¡£** - ç±»å‹å®šä¹‰å³æ–‡æ¡£
3. ğŸ“‹ **IDE æ”¯æŒ** - è‡ªåŠ¨è¡¥å…¨å’Œé”™è¯¯æ£€æŸ¥
4. ğŸ“‹ **ç»Ÿä¸€æ ‡å‡†** - å•ä¸€æ•°æ®æº

### é•¿æœŸæ”¶ç›Šï¼ˆæœªæ¥ï¼‰

1. ğŸ”® **è¿è¡Œæ—¶éªŒè¯** - Pydantic è‡ªåŠ¨éªŒè¯
2. ğŸ”® **è‡ªåŠ¨æµ‹è¯•** - åŸºäºç±»å‹å®šä¹‰ç”Ÿæˆæµ‹è¯•
3. ğŸ”® **ç‰ˆæœ¬ç®¡ç†** - æ”¯æŒ API ç‰ˆæœ¬æ¼”è¿›
4. ğŸ”® **æ€§èƒ½ä¼˜åŒ–** - å‡å°‘è¿è¡Œæ—¶ç±»å‹æ£€æŸ¥

## å®æ–½æ—¶é—´çº¿

### å·²å®Œæˆ âœ…

- [x] åˆ›å»ºæ™ºèƒ½äº‹ä»¶é€‚é…å™¨ (`eventAdapter.ts`)
- [x] æ›´æ–°å‰ç«¯ä½¿ç”¨é€‚é…å™¨ (`App.vue`)
- [x] ä¿®å¤ Python æ•°æ®æ ¼å¼ (`maya_outliner.py`)
- [x] åˆ›å»ºè®¾è®¡æ–‡æ¡£ (`DESIGN_TYPE_SAFE_EVENTS.md`)

### æœ¬å‘¨è®¡åˆ’ ğŸ“‹

- [ ] åˆ›å»ºäº‹ä»¶ç±»å‹å®šä¹‰ (`python/auroraview/events.py`)
- [ ] æ·»åŠ æ•°æ®è§„èŒƒåŒ–å‡½æ•°
- [ ] æ›´æ–° Maya Outliner ä½¿ç”¨ç±»å‹å®šä¹‰
- [ ] åˆ›å»ºç±»å‹ç”Ÿæˆè„šæœ¬

### æœªæ¥è®¡åˆ’ ğŸ”®

- [ ] é›†æˆ Pydantic éªŒè¯
- [ ] è‡ªåŠ¨ç”Ÿæˆ TypeScript ç±»å‹
- [ ] æ·»åŠ è¿è¡Œæ—¶éªŒè¯å¼€å…³
- [ ] åˆ›å»º API æ–‡æ¡£ç”Ÿæˆå™¨

## æœ€ä½³å®è·µ

### 1. å‰ç«¯å¼€å‘

```typescript
// âœ… æ¨èï¼šä½¿ç”¨ EventDataAdapter
const nodes = EventDataAdapter.extractArray<MayaNode>(data, 'nodes')

// âŒ ä¸æ¨èï¼šæ‰‹åŠ¨æ£€æŸ¥æ ¼å¼
const nodes = data?.nodes || data?.value || []
```

### 2. Python å¼€å‘

```python
# âœ… æ¨èï¼šä½¿ç”¨æ˜ç¡®çš„æ•°æ®ç»“æ„
self.webview.emit("scene_updated", {"nodes": hierarchy})

# âš ï¸ å¯ä»¥ä½†ä¸æ¨èï¼šç›´æ¥å‘é€æ•°ç»„
self.webview.emit("scene_updated", hierarchy)
```

### 3. æ·»åŠ æ–°äº‹ä»¶

1. åœ¨ `events.py` ä¸­å®šä¹‰ç±»å‹
2. åœ¨ `EventDataAdapter` ä¸­æ·»åŠ æå–æ–¹æ³•ï¼ˆå¦‚éœ€è¦ï¼‰
3. æ›´æ–°æ–‡æ¡£è¯´æ˜æ•°æ®æ ¼å¼
4. æ·»åŠ æµ‹è¯•ç”¨ä¾‹

## æ€»ç»“

é€šè¿‡å®æ–½**æ™ºèƒ½äº‹ä»¶é€‚é…å™¨**ï¼Œæˆ‘ä»¬ï¼š

1. âœ… **ç«‹å³è§£å†³äº†å½“å‰é—®é¢˜** - æ•°æ®æ ¼å¼ä¸åŒ¹é…
2. âœ… **æä¾›äº†é•¿æœŸè§£å†³æ–¹æ¡ˆ** - ä¸‰å±‚é˜²æŠ¤æœºåˆ¶
3. âœ… **ä¿æŒäº†å‘åå…¼å®¹** - ä¸ç ´åç°æœ‰ä»£ç 
4. âœ… **æ”¹å–„äº†å¼€å‘ä½“éªŒ** - æ›´å¥½çš„è°ƒè¯•å’Œé”™è¯¯æç¤º

è¿™æ˜¯ä¸€ä¸ª**æ¸è¿›å¼æ”¹è¿›**çš„å…¸èŒƒï¼š
- çŸ­æœŸï¼šå¿«é€Ÿä¿®å¤ï¼ˆæ™ºèƒ½é€‚é…å™¨ï¼‰
- ä¸­æœŸï¼šæ ‡å‡†åŒ–ï¼ˆç±»å‹å®šä¹‰ï¼‰
- é•¿æœŸï¼šè‡ªåŠ¨åŒ–ï¼ˆè¿è¡Œæ—¶éªŒè¯ï¼‰

æ¯ä¸€æ­¥éƒ½æ˜¯å¯é€‰çš„ï¼Œä¸ä¼šå¼ºåˆ¶è¦æ±‚ç«‹å³å®Œæˆæ‰€æœ‰æ”¹è¿›ã€‚

